name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: 'src/HealthVerse.sln'

jobs:
  # =============================================================================
  # FAST GATE: Build + Unit Tests + Architecture Tests
  # Runs on every push and PR - must pass before merge
  # =============================================================================
  fast-gate:
    name: ğŸš€ Fast Gate (Build + Unit + Arch Tests)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: ğŸ—ï¸ Build (Release)
      run: dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore

    - name: ğŸ§ª Run Unit Tests
      run: |
        dotnet test tests/HealthVerse.UnitTests/HealthVerse.UnitTests.csproj \
          -c Release \
          --no-build \
          --logger "trx;LogFileName=unit-tests.trx" \
          --results-directory ./TestResults/UnitTests
      continue-on-error: false

    - name: ğŸ›ï¸ Run Architecture Tests (Hard Gate)
      run: |
        dotnet test tests/HealthVerse.ArchitectureTests/HealthVerse.ArchitectureTests.csproj \
          -c Release \
          --no-build \
          --logger "trx;LogFileName=arch-tests.trx" \
          --results-directory ./TestResults/ArchTests
      continue-on-error: false

    - name: ğŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: fast-gate-test-results
        path: ./TestResults/
        retention-days: 30

  # =============================================================================
  # HEAVY GATE: Integration Tests (Requires Docker + Postgres)
  # Runs on every PR to main/develop - ensures DB compatibility
  # =============================================================================
  heavy-gate:
    name: ğŸ˜ Heavy Gate (Integration Tests + Postgres)
    runs-on: ubuntu-latest
    needs: fast-gate  # Only run if fast-gate passes
    
    services:
      # Note: Testcontainers will spawn its own Postgres container
      # This service is optional fallback
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: healthverse_test
          POSTGRES_PASSWORD: healthverse_test_pwd
          POSTGRES_DB: healthverse_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ³ Verify Docker
      run: |
        echo "=== Docker Version ==="
        docker version
        echo "=== Docker Info ==="
        docker info --format '{{.ServerVersion}}'

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: ğŸ—ï¸ Build (Release)
      run: dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore

    - name: ğŸ§ª Run Integration Tests (Testcontainers)
      run: |
        dotnet test tests/HealthVerse.IntegrationTests/HealthVerse.IntegrationTests.csproj \
          -c Release \
          --no-build \
          --logger "trx;LogFileName=integration-tests.trx" \
          --results-directory ./TestResults/IntegrationTests \
          --verbosity normal
      env:
        # Testcontainers configuration
        TESTCONTAINERS_RYUK_DISABLED: false
        DOCKER_HOST: unix:///var/run/docker.sock
      continue-on-error: false

    - name: ğŸ“¤ Upload Integration Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: heavy-gate-test-results
        path: ./TestResults/
        retention-days: 30

  # =============================================================================
  # CODE QUALITY: Format Check + Analyzers (Optional but recommended)
  # =============================================================================
  code-quality:
    name: ğŸ“ Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: ğŸ” Check Code Formatting
      run: |
        dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic
      continue-on-error: true  # Warning only for now, can be made strict later

    - name: ğŸ—ï¸ Build with Warnings
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} -c Release \
          /p:TreatWarningsAsErrors=false \
          /warnaserror- \
          2>&1 | tee build-warnings.log
      continue-on-error: true

    - name: ğŸ“¤ Upload Build Warnings Log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-warnings
        path: build-warnings.log
        retention-days: 7

  # =============================================================================
  # SUMMARY: Final status report
  # =============================================================================
  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [fast-gate, heavy-gate, code-quality]
    if: always()
    
    steps:
    - name: ğŸ“Š Check Results
      run: |
        echo "=== CI Pipeline Summary ==="
        echo "Fast Gate: ${{ needs.fast-gate.result }}"
        echo "Heavy Gate: ${{ needs.heavy-gate.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        
        if [[ "${{ needs.fast-gate.result }}" != "success" ]]; then
          echo "âŒ Fast Gate failed - PR cannot be merged"
          exit 1
        fi
        
        if [[ "${{ needs.heavy-gate.result }}" != "success" ]]; then
          echo "âŒ Heavy Gate failed - Integration tests need attention"
          exit 1
        fi
        
        echo "âœ… All quality gates passed!"
